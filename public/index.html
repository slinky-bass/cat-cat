<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>cat-cat!</title>
  <!-- Not present in the tutorial. Just for basic styling. -->
  <link rel="stylesheet" href="css/base.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react-dom.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
</head>

<body>
<div id="content"></div>
  <script type="text/babel">

    //######################## CATCAT BOX START ###########################
    var CatCatBox = React.createClass ({

      loadCommentsFromServer: function() {
        $.ajax({
          url: this.props.url,
          dataType: 'json',
          cache: false,

          //on success, set the state of the data defined in getInitialState to the new state
          success: function(data) {
            this.setState({data: data}); 
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },

      handleCommentSubmit: function(comment) {
        console.log(comment);

        $.ajax({
          url: this.props.url,
          dataType: 'json',
          type: 'POST',
          data: comment,
          success: function(data) {
            this.setState({data: data});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },

      deleteFunction: function(value) {
        this.setState(state => {
          state.data.splice(value, 1);
          return {data: state.data};
        });
      },

      //on load, set the initial state of the data array
      getInitialState: function() {
        return {data: []};
      },

      componentDidMount: function() {
        this.loadCommentsFromServer();
        setInterval(this.loadCommentsFromServer, this.props.pollInterval);
      },

      render: function() {
        return (
          <div className="catCatBox">
            <CatCatHeader />
            <CatCatGallery  data={this.state.data} deletePic={this.deleteFunction}/>
            <CatCatUpload onCommentSubmit={this.handleCommentSubmit} />
          </div>
        );
      }
    });
    //######################### CATCAT BOX END ############################

    //~~~~~~~~~~~~~~~ CATCAT HEADER START ~~~~~~~~~~~~~~~~~~~
    var CatCatHeader = React.createClass ({
      render: function() {
        return ( 
          <div> 
            <h1 className="catCatHeader">=(c^t c^t)=</h1>
            <p className="message">Happy belated birthday, from your two adoring pussycats</p>
          </div>
        );
      }
    });
    //~~~~~~~~~~~~~~~~ CATCAT GALLERY START ~~~~~~~~~~~~~~~~~~~~
    var CatCatGallery = React.createClass ({
      
      render: function() {
        var deletePic = this.props.deletePic;
        var catMaker = function(comment) {
          var catIndex = comment.id;

          return (
            <CatCatPic fileName={comment.author} key={comment.id} value={catIndex} deletePic={deletePic}></CatCatPic>
          );
        }

        var catNodes = this.props.data.map(catMaker);

        return (
          <div className="catCatGallery">
              {catNodes}
          </div>
        );
      }
    });
    //~~~~~~~~~~~~~~~~ CATCAT UPLOAD START ~~~~~~~~~~~~~~~~~~~~
    var CatCatUpload = React.createClass ({
      
      getInitialState: function() {
        return {author: '', text: ''};
      },

      handleFile: function(e) {
        var self = this;
        var reader = new FileReader();
        var file = e.target.files[0];

        reader.onload = function(upload) {
          self.setState({
            author: upload.target.result,
          });
        }
        reader.readAsDataURL(file);
      },

      handleTextChange: function(e) {
        this.setState({text: e.target.value});
      },

      handleSubmit: function(e) {
        e.preventDefault();
        var author = this.state.author.trim();
        var text = this.state.text.trim();
        if (!text || !author) {
          return;
        }
        this.props.onCommentSubmit({author: author, text: text});
        this.setState({author: '', text: ''});
      },

      render: function() {
        return (
          <form className="commentForm" onSubmit={this.handleSubmit} encType="multipart/form-data">
              <label htmlFor="fileInput">(brouwse)
                <input type="file" id="fileInput" placeholder="..." onChange={this.handleFile} required />
              </label>
              
              <input type="text" placeholder="Your random yet surprisingly witty comment here" value={this.state.text} onChange={this.handleTextChange}/>

              <div className="noseWrapper">
                <div className="triangle"></div>
                <input type="submit" value="FEED MEH" />
              </div>

          </form>
        );
      }
    });
    //~~~~~~~~~~~~~~~~ CATCAT UPLOAD END ~~~~~~~~~~~~~~~~~~~~~

    //......... CATCAT PIC START................
    var CatCatPic = React.createClass ({

      render: function() {
        return (
          <div className="catCatWrapper">  
            <img className="catCatImg" src={this.props.fileName} />
            <button className="deleteBtn" onClick={this.props.deletePic}>x</button>
          </div>  
        );
      }
    });
    //........... CATCAT PIC END ................

    //################# RENDER IT! RENDER IT FOREVER ##################
    //render the above defined component, CommentBox into the virtual ReactDOM. It is important that ReactDOM.render() remains at the bottom of the script block and that all components called are defined above it.
    //Note the PascalCase of the custom reactElement
    ReactDOM.render(
      <CatCatBox  url="/api/comments" pollInterval={20000} />,
      document.getElementById('content')
    );   

  </script>
</body>
</html>
